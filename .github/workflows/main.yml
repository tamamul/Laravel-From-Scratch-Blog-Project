name: Build Laravel ZIP + SQL

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: mbstring, pdo, pdo_mysql, tokenizer, xml, ctype, json

      - name: Install Composer Dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Copy .env and Generate Key
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Setup MySQL with proper authentication
        uses: ankane/setup-mysql@v1
        with:
          mysql-version: '8.0'
          root-password: root
          database: laravel_app

      - name: Configure MySQL for password access
        run: |
          # Reset MySQL root password dan konfigurasi akses
          sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';"
          sudo mysql -e "FLUSH PRIVILEGES;"
          sudo systemctl restart mysql

      - name: Wait for MySQL to be ready
        run: |
          sleep 5
          mysql -h 127.0.0.1 -u root -proot -e "SELECT 1;" --connect-timeout=30

      - name: Create and setup database
        run: |
          mysql -h 127.0.0.1 -u root -proot -e "CREATE DATABASE IF NOT EXISTS laravel_app;"
          mysql -h 127.0.0.1 -u root -proot -e "SHOW DATABASES;"

      - name: Update .env with database configuration
        run: |
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=laravel_app/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=root/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=root/' .env
          cat .env | grep DB_

      - name: Run Migrations
        run: |
          php artisan migrate --force

      - name: Run Seeders (if exists)
        run: |
          if [ -f "database/seeders/DatabaseSeeder.php" ]; then
            php artisan db:seed --force
          else
            echo "No seeders found, skipping..."
          fi

      - name: Dump Database
        run: |
          mysqldump -h 127.0.0.1 -u root -proot laravel_app > backup.sql
          echo "âœ… Database dump completed successfully!"
          echo "ðŸ“Š File size: $(ls -lh backup.sql | awk '{print $5}')"
          echo "ðŸ“„ First few lines:"
          head -n 5 backup.sql

      - name: Create production environment template
        run: |
          cat > .env.production << EOF
          APP_NAME="Laravel App"
          APP_ENV=production
          APP_KEY=$(grep APP_KEY .env | cut -d '=' -f2)
          APP_DEBUG=false
          APP_URL=http://localhost

          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=laravel_app
          DB_USERNAME=root
          DB_PASSWORD=root

          CACHE_DRIVER=file
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          EOF

      - name: Create ZIP Package
        run: |
          # Buat direktori temporary untuk package
          mkdir -p laravel-package
          
          # Copy semua file yang diperlukan (kecuali yang tidak perlu)
          cp -r app bootstrap config database public resources routes storage vendor laravel-package/
          cp artisan composer.json composer.lock .env.production backup.sql laravel-package/
          
          # Buat storage linkable
          cd laravel-package && mkdir -p storage/framework/cache storage/framework/sessions storage/framework/views
          
          # Buat ZIP
          zip -r ../laravel-package.zip .
          cd ..
          
          echo "âœ… Package created successfully!"
          ls -la *.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: laravel-package
          path: |
            laravel-package.zip
            backup.sql
            .env.production
          retention-days: 30

      - name: Show Success Message
        run: |
          echo "ðŸŽ‰ Build completed successfully!"
          echo "ðŸ“¦ Artifact 'laravel-package' contains:"
          echo "   - Laravel application (ready for deployment)"
          echo "   - Database dump (backup.sql)" 
          echo "   - Production environment template (.env.production)"
