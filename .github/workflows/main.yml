name: Build Laravel ZIP + SQL

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: mbstring, pdo, pdo_mysql, tokenizer, xml, ctype, json

      - name: Install Composer Dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Copy .env and Generate Key
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Setup MySQL
        uses: ankane/setup-mysql@v1
        with:
          mysql-version: '8.0'

      - name: Configure MySQL Access
        run: |
          sudo mysql -e "USE mysql; UPDATE user SET plugin='mysql_native_password' WHERE User='root'; FLUSH PRIVILEGES;"
          sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '';"
          sudo systemctl restart mysql
          sleep 3

      - name: Create Database and Run Migrations
        run: |
          mysql -u root -e "CREATE DATABASE IF NOT EXISTS laravel_app;"
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=laravel_app/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=root/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=/' .env
          php artisan migrate --force

      - name: Dump Database
        run: |
          mysqldump -u root laravel_app > backup.sql
          echo "Database dump completed. Size: $(wc -l < backup.sql) lines"

      - name: Create ZIP Package
        run: |
          zip -r laravel-package.zip . \
            -x ".git/*" \
            ".github/*" \
            "node_modules/*" \
            "tests/*" \
            "*.gitignore" \
            "README.md"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: laravel-package
          path: |
            laravel-package.zip
            backup.sql
          retention-days: 30
