name: Build Laravel ZIP + SQL

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: mbstring, pdo, pdo_mysql, tokenizer, xml, ctype, json

      - name: Install Composer Dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Copy .env and Generate Key
        run: |
          cp .env.example .env
          php artisan key:generate

      - name: Setup MySQL Service
        uses: ankane/setup-mysql@v1
        with:
          mysql-version: '8.0'
          root-password: root
          database: laravel_local

      - name: Wait for MySQL to be ready
        run: |
          sudo systemctl status mysql
          mysql -h 127.0.0.1 -u root -proot -e "SELECT 1;" --connect-timeout=30

      - name: Run Migrations and Seeders
        run: |
          mysql -h 127.0.0.1 -u root -proot -e "CREATE DATABASE IF NOT EXISTS laravel_local;"
          php artisan migrate --force
          php artisan db:seed --force

      - name: Dump Local Database
        run: |
          mysqldump -h 127.0.0.1 -u root -proot laravel_local > backup.sql
          echo "Database dump completed. File size: $(ls -lh backup.sql | awk '{print $5}')"
          head -n 10 backup.sql

      - name: Create .env.production
        run: |
          cat > .env.production << EOF
          APP_NAME=Laravel
          APP_ENV=production
          APP_KEY=$(php artisan key:generate --show)
          APP_DEBUG=false
          APP_URL=http://localhost
          
          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=laravel_local
          DB_USERNAME=root
          DB_PASSWORD=root
          EOF

      - name: Create ZIP Output
        run: |
          # File yang akan disertakan dalam package
          zip -r laravel-package.zip \
            . \
            -x ".git/*" \
            ".github/*" \
            "node_modules/*" \
            "tests/*" \
            "*.gitignore" \
            "README.md" \
            "backup.sql"  # Exclude backup.sql sementara

          # Tambahkan backup.sql secara terpisah
          zip -u laravel-package.zip backup.sql
          zip -u laravel-package.zip .env.production

          echo "Package created successfully!"
          ls -la *.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: laravel-package
          path: |
            laravel-package.zip
            backup.sql
          retention-days: 30

      - name: Show Artifact Info
        run: |
          echo "âœ… Build completed successfully!"
          echo "ðŸ“¦ Artifact contains:"
          echo "   - Laravel application (laravel-package.zip)"
          echo "   - Database dump (backup.sql)"
          echo "   - Production environment template (.env.production)"
